<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三种上报方式示例</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .method {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .method h2 {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .advantages {
            background: #e6fffa;
            border-left: 4px solid #38b2ac;
            padding: 10px 15px;
            margin: 10px 0;
        }
        .disadvantages {
            background: #fed7d7;
            border-left: 4px solid #e53e3e;
            padding: 10px 15px;
            margin: 10px 0;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005c99;
        }
        .demo-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>前端上报的三种主要方式</h1>
    
    <div class="method">
        <h2>一、图片上报 (Image Reporting)</h2>
        <p>通过创建Image对象，利用图片加载机制发送数据到服务器。这是最常用的上报方式。</p>
        
        <div class="code-block">
<pre>
const dsn_url = 'https://your-server.com/report';
const reportByImage = (message) => {
    const img = new Image();
    img.src = `${dsn_url}?message=${encodeURIComponent(message)}&timestamp=${Date.now()}`;
    
    // 可选：添加加载成功和失败的回调
    img.onload = () => console.log('图片上报成功');
    img.onerror = () => console.log('图片上报失败');
}
</pre>
        </div>
        
        <div class="advantages">
            <strong>优势：</strong>
            <ul>
                <li>无跨域限制</li>
                <li>兼容性极好，支持所有浏览器</li>
                <li>实现简单</li>
                <li>不受页面卸载影响</li>
            </ul>
        </div>
        
        <div class="disadvantages">
            <strong>劣势：</strong>
            <ul>
                <li>只能发送GET请求</li>
                <li>数据量受URL长度限制</li>
                <li>无法获取服务器响应内容</li>
            </ul>
        </div>
        
        <div class="demo-section">
            <button onclick="reportByImage('图片上报测试消息')">测试图片上报</button>
        </div>
    </div>

    <div class="method">
        <h2>二、Fetch上报 (Fetch Reporting)</h2>
        <p>使用现代的Fetch API发送数据，支持更多的HTTP方法和更灵活的数据格式。</p>
        
        <div class="code-block">
<pre>
const dsn_url = 'https://your-server.com/report';
const reportByFetch = async (message) => {
    try {
        const response = await fetch(dsn_url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                timestamp: Date.now(),
                userAgent: navigator.userAgent,
                url: window.location.href
            }),
            // 解决跨域问题的配置
            mode: 'cors',
            // 不发送cookie (可选)
            credentials: 'omit'
        });
        
        if (response.ok) {
            console.log('Fetch上报成功');
            const result = await response.json();
            console.log('服务器响应:', result);
        } else {
            console.error('Fetch上报失败:', response.status);
        }
    } catch (error) {
        console.error('Fetch上报错误:', error);
        // 失败时可以fallback到图片上报
        reportByImage(message);
    }
}
</pre>
        </div>
        
        <div class="advantages">
            <strong>优势：</strong>
            <ul>
                <li>支持POST、PUT等多种HTTP方法</li>
                <li>可以发送JSON、FormData等多种数据格式</li>
                <li>能够获取服务器响应</li>
                <li>支持Promise，便于错误处理</li>
                <li>可以设置请求头</li>
            </ul>
        </div>
        
        <div class="disadvantages">
            <strong>劣势：</strong>
            <ul>
                <li>存在跨域限制，需要服务器配置CORS</li>
                <li>在页面卸载时可能被取消</li>
                <li>兼容性相对较差（IE不支持）</li>
                <li>网络异常时容易失败</li>
            </ul>
        </div>
        
        <div class="demo-section">
            <button onclick="reportByFetch('Fetch上报测试消息')">测试Fetch上报</button>
        </div>
    </div>

    <div class="method">
        <h2>三、SendBeacon上报 (Beacon Reporting)</h2>
        <p>专门为页面卸载时的数据上报设计的API，即使在页面关闭时也能可靠地发送数据。</p>
        
        <div class="code-block">
<pre>
const dsn_url = 'https://your-server.com/report';
const reportByBeacon = (message) => {
    // 检查浏览器是否支持sendBeacon
    if (!navigator.sendBeacon) {
        console.log('浏览器不支持sendBeacon，使用图片上报');
        reportByImage(message);
        return;
    }
    
    const data = JSON.stringify({
        message: message,
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        url: window.location.href
    });
    
    // 发送数据
    const success = navigator.sendBeacon(dsn_url, data);
    
    if (success) {
        console.log('Beacon上报已发送');
    } else {
        console.log('Beacon上报失败，使用备用方案');
        reportByImage(message);
    }
}

// 页面卸载时自动上报
window.addEventListener('beforeunload', () => {
    reportByBeacon('页面卸载上报');
});

// 页面隐藏时上报（适用于移动端）
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        reportByBeacon('页面隐藏上报');
    }
});
</pre>
        </div>
        
        <div class="advantages">
            <strong>优势：</strong>
            <ul>
                <li>专为页面卸载场景设计，可靠性最高</li>
                <li>异步发送，不阻塞页面卸载</li>
                <li>浏览器保证在合适的时机发送</li>
                <li>支持POST请求</li>
                <li>数据大小限制相对宽松（通常64KB）</li>
            </ul>
        </div>
        
        <div class="disadvantages">
            <strong>劣势：</strong>
            <ul>
                <li>无法获取服务器响应</li>
                <li>兼容性有限（IE完全不支持）</li>
                <li>存在跨域限制</li>
                <li>只能发送特定的数据类型</li>
            </ul>
        </div>
        
        <div class="demo-section">
            <button onclick="reportByBeacon('Beacon上报测试消息')">测试Beacon上报</button>
        </div>
    </div>

    <div class="method">
        <h2>综合上报策略</h2>
        <p>在实际项目中，通常会结合多种方式，根据场景选择最合适的上报方法：</p>
        
        <div class="code-block">
<pre>
class Reporter {
    constructor(dsn_url) {
        this.dsn_url = dsn_url;
    }
    
    // 智能上报：根据场景自动选择最佳方式
    report(message, options = {}) {
        const { urgent = false, onUnload = false } = options;
        
        if (onUnload) {
            // 页面卸载时优先使用sendBeacon
            this.reportByBeacon(message);
        } else if (urgent) {
            // 紧急数据优先使用fetch
            this.reportByFetch(message);
        } else {
            // 普通上报使用图片方式
            this.reportByImage(message);
        }
    }
    
    reportByImage(message) {
        const img = new Image();
        img.src = `${this.dsn_url}?data=${encodeURIComponent(JSON.stringify({
            message,
            timestamp: Date.now(),
            method: 'image'
        }))}`;
    }
    
    async reportByFetch(message) {
        try {
            await fetch(this.dsn_url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message,
                    timestamp: Date.now(),
                    method: 'fetch'
                }),
                mode: 'cors'
            });
        } catch (error) {
            // fetch失败时降级到图片上报
            this.reportByImage(message);
        }
    }
    
    reportByBeacon(message) {
        if (navigator.sendBeacon) {
            const data = JSON.stringify({
                message,
                timestamp: Date.now(),
                method: 'beacon'
            });
            
            const success = navigator.sendBeacon(this.dsn_url, data);
            if (!success) {
                this.reportByImage(message);
            }
        } else {
            this.reportByImage(message);
        }
    }
}

// 使用示例
const reporter = new Reporter('https://your-server.com/report');

// 普通上报
reporter.report('用户点击按钮');

// 紧急数据上报
reporter.report('支付成功', { urgent: true });

// 页面卸载时上报
window.addEventListener('beforeunload', () => {
    reporter.report('用户离开页面', { onUnload: true });
});
</pre>
        </div>
        
        <div class="demo-section">
            <button onclick="testComprehensiveReporting()">测试综合上报策略</button>
        </div>
    </div>

    <script>
        // 模拟服务器地址（实际使用时替换为真实地址）
        const dsn_url = 'https://httpbin.org/post';
        
        // 图片上报实现
        const reportByImage = (message) => {
            const img = new Image();
            // 使用httpbin.org作为测试服务器
            img.src = `https://httpbin.org/get?message=${encodeURIComponent(message)}&timestamp=${Date.now()}&method=image`;
            
            img.onload = () => {
                console.log('✅ 图片上报成功:', message);
                showResult('图片上报成功');
            };
            img.onerror = () => {
                console.log('❌ 图片上报失败:', message);
                showResult('图片上报失败');
            };
        };
        
        // Fetch上报实现
        const reportByFetch = async (message) => {
            try {
                const response = await fetch(dsn_url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        timestamp: Date.now(),
                        method: 'fetch',
                        userAgent: navigator.userAgent,
                        url: window.location.href
                    }),
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Fetch上报成功:', result);
                    showResult('Fetch上报成功');
                } else {
                    console.error('❌ Fetch上报失败:', response.status);
                    showResult('Fetch上报失败，状态码：' + response.status);
                }
            } catch (error) {
                console.error('❌ Fetch上报错误:', error);
                showResult('Fetch上报错误：' + error.message);
                // 失败时fallback到图片上报
                reportByImage(message);
            }
        };
        
        // SendBeacon上报实现
        const reportByBeacon = (message) => {
            if (!navigator.sendBeacon) {
                console.log('浏览器不支持sendBeacon');
                showResult('浏览器不支持sendBeacon，使用图片上报');
                reportByImage(message);
                return;
            }
            
            const data = JSON.stringify({
                message: message,
                timestamp: Date.now(),
                method: 'beacon',
                userAgent: navigator.userAgent,
                url: window.location.href
            });
            
            const success = navigator.sendBeacon(dsn_url, data);
            
            if (success) {
                console.log('✅ Beacon上报已发送:', message);
                showResult('Beacon上报已发送');
            } else {
                console.log('❌ Beacon上报失败:', message);
                showResult('Beacon上报失败，使用图片上报备用');
                reportByImage(message);
            }
        };
        
        // 综合上报类
        class Reporter {
            constructor(dsn_url) {
                this.dsn_url = dsn_url;
            }
            
            report(message, options = {}) {
                const { urgent = false, onUnload = false } = options;
                
                if (onUnload) {
                    reportByBeacon(message);
                } else if (urgent) {
                    reportByFetch(message);
                } else {
                    reportByImage(message);
                }
            }
        }
        
        const reporter = new Reporter(dsn_url);
        
        // 测试综合上报策略
        const testComprehensiveReporting = () => {
            reporter.report('普通消息');
            setTimeout(() => reporter.report('紧急消息', { urgent: true }), 1000);
            setTimeout(() => reporter.report('卸载消息', { onUnload: true }), 2000);
        };
        
        // 显示结果的辅助函数
        function showResult(message) {
            // 创建或获取结果显示区域
            let resultDiv = document.getElementById('result');
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.id = 'result';
                resultDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #333;
                    color: white;
                    padding: 10px;
                    border-radius: 5px;
                    z-index: 1000;
                    max-width: 300px;
                `;
                document.body.appendChild(resultDiv);
            }
            
            resultDiv.textContent = message;
            
            // 3秒后自动隐藏
            setTimeout(() => {
                if (resultDiv.parentNode) {
                    resultDiv.parentNode.removeChild(resultDiv);
                }
            }, 3000);
        }
        
        // 页面卸载时的上报示例（实际项目中使用）
        window.addEventListener('beforeunload', () => {
            reporter.report('用户离开页面', { onUnload: true });
        });
        
        // 页面隐藏时的上报（移动端友好）
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                reporter.report('页面隐藏', { onUnload: true });
            }
        });
    </script>
</body>
</html>