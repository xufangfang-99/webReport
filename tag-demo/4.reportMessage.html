<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å±€åŸ‹ç‚¹å·¥å…· SDK</title>
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-area {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            margin: 10px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover {
            background: #0056b3;
        }
        .form-group {
            margin: 10px 0;
        }
        input, select {
            margin: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>å…¨å±€åŸ‹ç‚¹å·¥å…· SDK æ¼”ç¤º</h1>
    
    <div class="test-area">
        <h2>æµ‹è¯•åŒºåŸŸ</h2>
        <button class="btn" data-track="button-click" data-module="test">ç‚¹å‡»æŒ‰é’®</button>
        <button class="btn" data-track="special-action" data-user-id="123">ç‰¹æ®Šæ“ä½œ</button>
        
        <div class="form-group">
            <input type="text" placeholder="è¾“å…¥æ¡†æµ‹è¯•" data-track="input-focus" data-module="form">
            <select data-track="select-change" data-module="form">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="1">é€‰é¡¹1</option>
                <option value="2">é€‰é¡¹2</option>
            </select>
        </div>
        
        <div data-track="div-click" data-module="content" style="padding: 10px; background: #e9ecef; cursor: pointer;">
            å¯ç‚¹å‡»çš„DIVåŒºåŸŸ
        </div>
    </div>

    <div class="test-area">
        <h2>æ§åˆ¶å°æ—¥å¿—</h2>
        <div id="logArea" class="log-area"></div>
        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        // å…¨å±€åŸ‹ç‚¹å·¥å…· SDK
        class TrackingSDK {
            constructor(options = {}) {
                this.config = {
                    // åŸºç¡€é…ç½®
                    debug: options.debug || false,
                    autoTrack: options.autoTrack !== false, // é»˜è®¤å¼€å¯è‡ªåŠ¨åŸ‹ç‚¹
                    reportUrl: options.reportUrl || '/api/track',
                    batchSize: options.batchSize || 10,
                    timeout: options.timeout || 5000,
                    
                    // ç”¨æˆ·ä¿¡æ¯
                    userId: options.userId || null,
                    sessionId: options.sessionId || this.generateSessionId(),
                    
                    // é¡µé¢ä¿¡æ¯
                    pageId: options.pageId || this.getPageId(),
                    
                    // è¿‡æ»¤é…ç½®
                    ignoreElements: options.ignoreElements || ['script', 'style', 'meta', 'title'],
                    trackAttributes: options.trackAttributes || ['data-track', 'id', 'class']
                };
                
                // äº‹ä»¶é˜Ÿåˆ—
                this.eventQueue = [];
                this.isReporting = false;
                
                // åˆå§‹åŒ–
                this.init();
            }
            
            // åˆå§‹åŒ–æ–¹æ³•
            init() {
                if (this.config.autoTrack) {
                    this.setupAutoTracking();
                }
                this.setupErrorTracking();
                this.setupPerformanceTracking();
                this.setupPageTracking();
                
                this.log('TrackingSDK åˆå§‹åŒ–å®Œæˆ', this.config);
            }
            
            // è®¾ç½®è‡ªåŠ¨åŸ‹ç‚¹
            setupAutoTracking() {
                // å…¨å±€ç‚¹å‡»äº‹ä»¶ç›‘å¬
                document.addEventListener('click', (event) => {
                    this.handleAutoTrack('click', event);
                }, true);
                
                // è¾“å…¥æ¡†èšç„¦äº‹ä»¶
                document.addEventListener('focus', (event) => {
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                        this.handleAutoTrack('focus', event);
                    }
                }, true);
                
                // é€‰æ‹©æ¡†å˜åŒ–äº‹ä»¶
                document.addEventListener('change', (event) => {
                    if (event.target.tagName === 'SELECT' || event.target.type === 'checkbox' || event.target.type === 'radio') {
                        this.handleAutoTrack('change', event);
                    }
                }, true);
            }
            
            // å¤„ç†è‡ªåŠ¨åŸ‹ç‚¹
            handleAutoTrack(eventType, event) {
                const target = event.target;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦å¿½ç•¥
                if (this.shouldIgnoreElement(target)) {
                    return;
                }
                
                const trackData = this.extractTrackData(target, event);
                
                // åªæœ‰æ˜ç¡®æ ‡è®°äº†åŸ‹ç‚¹å±æ€§çš„å…ƒç´ æ‰è¿›è¡ŒåŸ‹ç‚¹
                if (target.hasAttribute('data-track') || this.config.debug) {
                    this.track(eventType, trackData);
                }
            }
            
            // æå–åŸ‹ç‚¹æ•°æ®
            extractTrackData(target, event) {
                const data = {
                    // åŸºç¡€ä¿¡æ¯
                    timestamp: Date.now(),
                    url: window.location.href,
                    title: document.title,
                    userAgent: navigator.userAgent,
                    
                    // å…ƒç´ ä¿¡æ¯
                    tagName: target.tagName.toLowerCase(),
                    xpath: this.getXPath(event),
                    elementId: target.id || null,
                    className: target.className || null,
                    innerText: target.innerText ? target.innerText.substring(0, 100) : null,
                    
                    // è‡ªå®šä¹‰å±æ€§
                    trackId: target.getAttribute('data-track') || null,
                    module: target.getAttribute('data-module') || null,
                    
                    // ä½ç½®ä¿¡æ¯
                    clientX: event.clientX,
                    clientY: event.clientY,
                    
                    // é¡µé¢æ»šåŠ¨ä½ç½®
                    scrollX: window.pageXOffset,
                    scrollY: window.pageYOffset,
                };
                
                // æå–æ‰€æœ‰data-*å±æ€§
                Array.from(target.attributes).forEach(attr => {
                    if (attr.name.startsWith('data-')) {
                        data[attr.name] = attr.value;
                    }
                });
                
                return data;
            }
            
            // è·å–å…ƒç´ XPath
            getXPath(event) {
                const paths = event.path || event.composedPath();
                return paths
                    .filter(item => item.tagName)
                    .map(item => {
                        let selector = item.tagName.toLowerCase();
                        if (item.id) {
                            selector += `#${item.id}`;
                        } else if (item.className) {
                            const classes = item.className.split(' ').filter(c => c).slice(0, 2);
                            if (classes.length > 0) {
                                selector += `.${classes.join('.')}`;
                            }
                        }
                        return selector;
                    })
                    .reverse()
                    .join(' > ');
            }
            
            // æ£€æŸ¥æ˜¯å¦åº”è¯¥å¿½ç•¥å…ƒç´ 
            shouldIgnoreElement(element) {
                const tagName = element.tagName.toLowerCase();
                return this.config.ignoreElements.includes(tagName);
            }
            
            // æ‰‹åŠ¨åŸ‹ç‚¹æ–¹æ³•
            track(eventName, data = {}) {
                const eventData = {
                    eventName,
                    ...data,
                    userId: this.config.userId,
                    sessionId: this.config.sessionId,
                    pageId: this.config.pageId,
                    timestamp: data.timestamp || Date.now()
                };
                
                this.log('åŸ‹ç‚¹äº‹ä»¶:', eventData);
                
                // æ·»åŠ åˆ°é˜Ÿåˆ—
                this.eventQueue.push(eventData);
                
                // æ‰¹é‡ä¸ŠæŠ¥
                if (this.eventQueue.length >= this.config.batchSize) {
                    this.report();
                }
            }
            
            // è®¾ç½®é”™è¯¯ç›‘æ§
            setupErrorTracking() {
                // JavaScripté”™è¯¯
                window.onerror = (msg, url, line, col, error) => {
                    this.track('javascript_error', {
                        message: msg,
                        filename: url,
                        line,
                        column: col,
                        stack: error ? error.stack : null
                    });
                };
                
                // Promiseé”™è¯¯
                window.addEventListener('unhandledrejection', (event) => {
                    this.track('promise_error', {
                        reason: event.reason,
                        promise: event.promise
                    });
                });
            }
            
            // è®¾ç½®æ€§èƒ½ç›‘æ§
            setupPerformanceTracking() {
                // é¡µé¢åŠ è½½å®Œæˆåæ”¶é›†æ€§èƒ½æ•°æ®
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        const perfData = this.getPerformanceData();
                        if (perfData) {
                            this.track('page_performance', perfData);
                        }
                    }, 0);
                });
            }
            
            // è·å–æ€§èƒ½æ•°æ®
            getPerformanceData() {
                if (!window.performance || !window.performance.timing) {
                    return null;
                }
                
                const timing = window.performance.timing;
                const navigationStart = timing.navigationStart;
                
                return {
                    // é¡µé¢åŠ è½½æ—¶é—´
                    loadTime: timing.loadEventEnd - navigationStart,
                    // DOMè§£ææ—¶é—´
                    domParseTime: timing.domContentLoadedEventEnd - timing.domLoading,
                    // ç™½å±æ—¶é—´
                    whiteScreenTime: timing.responseStart - navigationStart,
                    // é¦–å±æ—¶é—´
                    firstScreenTime: timing.loadEventEnd - navigationStart
                };
            }
            
            // è®¾ç½®é¡µé¢è·Ÿè¸ª
            setupPageTracking() {
                // é¡µé¢è¿›å…¥
                this.track('page_enter', {
                    referrer: document.referrer
                });
                
                // é¡µé¢ç¦»å¼€
                window.addEventListener('beforeunload', () => {
                    this.track('page_leave', {
                        stayTime: Date.now() - this.pageEnterTime
                    });
                    this.report(true); // å¼ºåˆ¶ä¸ŠæŠ¥
                });
                
                this.pageEnterTime = Date.now();
            }
            
            // ä¸ŠæŠ¥æ•°æ®
            report(force = false) {
                if (this.isReporting && !force) {
                    return;
                }
                
                if (this.eventQueue.length === 0) {
                    return;
                }
                
                this.isReporting = true;
                const events = [...this.eventQueue];
                this.eventQueue = [];
                
                this.log('ä¸ŠæŠ¥æ•°æ®:', events);
                
                // æ¨¡æ‹Ÿä¸ŠæŠ¥ï¼ˆå®é™…é¡¹ç›®ä¸­æ›¿æ¢ä¸ºçœŸå®çš„ä¸ŠæŠ¥é€»è¾‘ï¼‰
                if (this.config.debug) {
                    console.log('ğŸ“Š åŸ‹ç‚¹æ•°æ®ä¸ŠæŠ¥:', events);
                    this.isReporting = false;
                    return;
                }
                
                // çœŸå®ä¸ŠæŠ¥é€»è¾‘
                fetch(this.config.reportUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        events,
                        timestamp: Date.now()
                    })
                }).then(response => {
                    this.log('ä¸ŠæŠ¥æˆåŠŸ:', response);
                }).catch(error => {
                    this.log('ä¸ŠæŠ¥å¤±è´¥:', error);
                    // ä¸ŠæŠ¥å¤±è´¥æ—¶é‡æ–°åŠ å…¥é˜Ÿåˆ—
                    this.eventQueue.unshift(...events);
                }).finally(() => {
                    this.isReporting = false;
                });
            }
            
            // å·¥å…·æ–¹æ³•
            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            getPageId() {
                return window.location.pathname.replace(/\//g, '_') || 'index';
            }
            
            log(...args) {
                if (this.config.debug) {
                    console.log('[TrackingSDK]', ...args);
                    
                    // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
                    const logArea = document.getElementById('logArea');
                    if (logArea) {
                        const logEntry = document.createElement('div');
                        logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${args.map(arg => 
                            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
                        ).join(' ')}`;
                        logArea.appendChild(logEntry);
                        logArea.scrollTop = logArea.scrollHeight;
                    }
                }
            }
            
            // å…¬å…±API
            setUserId(userId) {
                this.config.userId = userId;
            }
            
            setConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
            }
            
            // æ‰‹åŠ¨è§¦å‘ä¸ŠæŠ¥
            flush() {
                this.report(true);
            }
        }
        
        // åˆå§‹åŒ–SDK
        window.TrackingSDK = TrackingSDK;
        
        // åˆ›å»ºå®ä¾‹
        const tracker = new TrackingSDK({
            debug: true,
            userId: 'user_123',
            autoTrack: true
        });
        
        // æš´éœ²åˆ°å…¨å±€
        window.tracker = tracker;
        
        // æ¸…ç©ºæ—¥å¿—å‡½æ•°
        function clearLogs() {
            const logArea = document.getElementById('logArea');
            if (logArea) {
                logArea.innerHTML = '';
            }
        }
        
        // æ¼”ç¤ºæ‰‹åŠ¨åŸ‹ç‚¹
        setTimeout(() => {
            tracker.track('custom_event', {
                action: 'demo_load',
                value: 'SDKæ¼”ç¤ºé¡µé¢åŠ è½½å®Œæˆ'
            });
        }, 1000);
    </script>
</body>
</html>